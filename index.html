<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Isometric Ultima Demo</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #000;
      color: #fff;
      font-family: Consolas, "Lucida Console", monospace;
      height: 100%; width: 100%;
      overflow: hidden;
    }
    #mainContainer {
      display: flex;
      flex-direction: row;
      width: 100%; height: 100vh;
      box-sizing: border-box;
    }
    #leftPanel {
      flex: 0 0 auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    #gameCanvas {
      background: #000;
      width: 800px;
      height: 600px;
    }
    #rightPanel {
      flex: 1 1 auto;
      padding: 1rem;
      background: #222;
      display: flex;
      flex-direction: column;
      overflow: auto;
    }
    #playerStats { margin-bottom: .5rem; font-size: 16px; color: #0f0; }
    #messages { margin-bottom: .5rem; font-size: 14px; color: #ff9; }
    #dialogues { margin-bottom: .5rem; font-size: 14px; color: #9cf; }
    #commandsHelp { font-size: 14px; color: #ccc; margin-top: auto; }
    #commandsHelp ul { list-style: none; margin: 0; padding: 0; }
    #commandsHelp li { margin-bottom: .3rem; }
    #commandsHelp strong { color: #fff; }
  </style>
</head>
<body>
<div id="mainContainer">
  <div id="leftPanel">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
  </div>
  <div id="rightPanel">
    <div id="playerStats"></div>
    <div id="messages"></div>
    <div id="dialogues"></div>
    <div id="commandsHelp">
      <strong>Commands (Ultima + KC):</strong>
      <ul>
        <li><strong>Arrow Keys</strong>: Move (~333 ms cooldown)</li>
        <li><strong>T</strong>: Take item on your tile</li>
        <li><strong>E</strong>: Talk to adjacent NPC (branching dialogues)</li>
        <li><strong>I</strong>: Show inventory</li>
        <li><strong>F</strong>: Block wizard’s fireball</li>
        <li><strong>S</strong>: "Szał Bitewny" (Rage) for +20 SF (5s)</li>
      </ul>
    </div>
  </div>
</div>

<script>
// ----- CONFIGURATION -----
const MAP_WIDTH = 96, MAP_HEIGHT = 32;
const CAMERA_WIDTH = 32, CAMERA_HEIGHT = 12;
const TILE_W = 32, TILE_H = 16;

const gameData = {
  tileDefs: {
    GRASS: { color: "#2f2", passable: true },
    FOREST: { color: "#0a0", passable: true },
    MOUNTAIN: { color: "#ddd", passable: false },
    HILL: { color: "#bbb", passable: true },
    WATER: { color: "#06a", passable: true },
    ROAD: { color: "#aaa", passable: true },
    WALL: { color: "#ccc", passable: false },
    CASTLE: { color: "#ccc", passable: false },
    CITY: { color: "#fa4", passable: true }
  },
  specialTiles: {
    NPC: { color: "#0cf" },
    ITEM: { color: "#fa0" },
    FIREBALL: { color: "#f44" },
    PLAYER: "#ff0"
  },
  items: [
    { x: 10, y: 3, name: "Sword", taken: false },
    { x: 30, y: 8, name: "Potion", taken: false }
  ],
  npcs: [
    {
      name: "Guard",
      x: 15, y: 8,
      color: "#ff0",
      path: [{ x: 15, y: 8 }, { x: 19, y: 8 }, { x: 19, y: 10 }, { x: 15, y: 10 }],
      pathIndex: 0,
      state: 0,
      dialogues: [
        "Guard(0): \"Halt, traveler! (E) to talk.\"",
        "Guard(1): \"(1) Name? Keep pressing E...\"",
        "Guard(2): \"(2) We watch roads...\"",
        "Guard(3): \"(3) Are you (G)ood or (E)vil?\"",
        "Guard(4): \"(4) Aha, interesting...\"",
        "Guard(5): \"(5) 5 lines done, 5 left...\"",
        "Guard(6): \"(6) I'm bored...\"",
        "Guard(7): \"(7) 3 more...\"",
        "Guard(8): \"(8) 2 more...\"",
        "Guard(9): \"(9) 1 more...\"",
        "Guard(10): \"(10) Done. Bye!\""
      ]
    },
    {
      name: "Wizard",
      x: 40, y: 5,
      color: "#f0f",
      path: [{ x: 40, y: 5 }, { x: 44, y: 5 }, { x: 44, y: 9 }, { x: 40, y: 9 }],
      pathIndex: 0,
      state: 0,
      dialogues: [
        "Wizard(0): \"Greetings. (E) to chat.\"",
        "Wizard(1): \"(1) I'm studying fire magic... (Y/N)?\"",
        "Wizard(2): \"(2) Great, I'll show you some spells!\"",
        "Wizard(3): \"(3) Fine, I'll keep them secret.\"",
        "Wizard(4): \"(4) I might hurl a fireball, watch out!\"",
        "Wizard(5): \"(5) If you see it, press (F) to block...\"",
        "Wizard(6): \"(6) I'm done talking soon...\"",
        "Wizard(7): \"(7) 3 lines left...\"",
        "Wizard(8): \"(8) 2 lines...\"",
        "Wizard(9): \"(9) 1 line...\"",
        "Wizard(10): \"(10) Enough!\""
      ]
    }
  ],
  projectiles: []
};

let map = Array.from({length: MAP_HEIGHT}, () => Array(MAP_WIDTH).fill("GRASS"));
function randElem(arr){return arr[Math.floor(Math.random()*arr.length)];}
const baseTerrains=["GRASS","FOREST","MOUNTAIN","HILL","WATER"];
for(let y=0;y<MAP_HEIGHT;y++){
  for(let x=0;x<MAP_WIDTH;x++){
    map[y][x]=randElem(baseTerrains);
  }
}
map[10][10]="GRASS";
for(let yy=10;yy<14;yy++){for(let xx=60;xx<64;xx++){map[yy][xx]="CITY";}}
for(let xx=59;xx<=64;xx++){map[10][xx]="WALL";map[13][xx]="WALL";}
for(let yy=10;yy<=13;yy++){map[yy][59]="WALL";map[yy][64]="WALL";}

let isRunning=true;
let score=0;
let playerX=10,playerY=10;
let walkFrame=0,moveDelay=333,lastMove=0;
let playerStats={name:"BezImienny",ZYW:100,currentHP:100,SF:60,ZR:50,UM:30,WI:40,SZ:20,PM:20,inventory:[]};
let rageActive=false,rageTimer=0;
let dayTime=0;function currentDayPhase(){if(dayTime<1200) return"Day";else if(dayTime<1800) return"Evening";else return"Night";}

let keys={ArrowUp:false,ArrowDown:false,ArrowLeft:false,ArrowRight:false,t:false,T:false,e:false,E:false,i:false,I:false,f:false,F:false,s:false,S:false,g:false,G:false,y:false,Y:false,n:false,N:false};
window.addEventListener("keydown",e=>{if(keys[e.key]!==undefined) keys[e.key]=true;});
window.addEventListener("keyup",e=>{if(keys[e.key]!==undefined) keys[e.key]=false;});

const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const messagesDiv=document.getElementById('messages');
const dialoguesDiv=document.getElementById('dialogues');
const statsDiv=document.getElementById('playerStats');

function isNPCat(nx,ny){return gameData.npcs.find(n=>n.x===nx&&n.y===ny);} 
function isPassable(nx,ny){if(nx<0||ny<0||nx>=MAP_WIDTH||ny>=MAP_HEIGHT) return false;let npc=isNPCat(nx,ny);if(npc) return false;let td=gameData.tileDefs[map[ny][nx]]||gameData.tileDefs.GRASS;return td.passable!==false;} 
function isAdjacent(px,py,nx,ny){return Math.abs(px-nx)+Math.abs(py-ny)===1;}

let npcMoveInterval=1000,lastNPCmove=0;
function updateNPCs(){let now=Date.now();if(now-lastNPCmove<npcMoveInterval) return;lastNPCmove=now;for(let npc of gameData.npcs){if(!npc.path||npc.path.length<2) continue;if(npc.pathIndex===undefined) npc.pathIndex=0;let tgt=npc.path[npc.pathIndex];if(npc.x===tgt.x&&npc.y===tgt.y){npc.pathIndex=(npc.pathIndex+1)%npc.path.length;tgt=npc.path[npc.pathIndex];}let dx=0,dy=0;if(npc.x<tgt.x) dx=1;else if(npc.x>tgt.x) dx=-1;else if(npc.y<tgt.y) dy=1;else if(npc.y>tgt.y) dy=-1;let nx=npc.x+dx,ny=npc.y+dy;if(isPassable(nx,ny)){npc.x=nx;npc.y=ny;}}
let wizard=gameData.npcs.find(n=>n.name==="Wizard");if(wizard&&Math.random()<0.33){let dx=playerX-wizard.x,dy=playerY-wizard.y;if(Math.abs(dx)>Math.abs(dy)){gameData.projectiles.push({x:wizard.x,y:wizard.y,dx:(dx>0?1:-1),dy:0,type:"FIREBALL"});messagesDiv.textContent="Wizard hurls a fireball horizontally!";}else{gameData.projectiles.push({x:wizard.x,y:wizard.y,dx:0,dy:(dy>0?1:-1),type:"FIREBALL"});messagesDiv.textContent="Wizard flings a vertical fireball!";}}}

function updateProjectiles(){let removeList=[];for(let p of gameData.projectiles){p.x+=p.dx;p.y+=p.dy;if(p.x<0||p.y<0||p.x>=MAP_WIDTH||p.y>=MAP_HEIGHT){removeList.push(p);continue;}if(p.x===playerX&&p.y===playerY){if(keys.f||keys.F){messagesDiv.textContent="You block the fireball with perfect timing!";}else{playerStats.currentHP-=10;messagesDiv.textContent="Fireball hits you for 10 damage!";if(playerStats.currentHP<=0){playerStats.currentHP=0;messagesDiv.textContent+=" You died! Game Over.";isRunning=false;}}removeList.push(p);}else if(!isPassable(p.x,p.y)){removeList.push(p);}}
gameData.projectiles=gameData.projectiles.filter(x=>!removeList.includes(x));}

let lastDayUpdate=0;messagesDiv.textContent="Map generated. Use arrow keys to move. 'S' for Szał. 'F' to block fireballs.";

let cameraXFloat=0,cameraYFloat=0;
function isoCoords(rx,ry){return{sx:(rx-ry)*TILE_W/2,sy:(rx+ry)*TILE_H/2};}

function gameLoop(){if(!isRunning) return;let now=Date.now();if(now-lastDayUpdate>1000){dayTime=(dayTime+20)%2400;lastDayUpdate=now;}updateNPCs();updateProjectiles();if(now-lastMove>=moveDelay){let moved=false;if(keys.ArrowUp&&isPassable(playerX,playerY-1)){playerY--;moved=true;}else if(keys.ArrowDown&&isPassable(playerX,playerY+1)){playerY++;moved=true;}else if(keys.ArrowLeft&&isPassable(playerX-1,playerY)){playerX--;moved=true;}else if(keys.ArrowRight&&isPassable(playerX+1,playerY)){playerX++;moved=true;}if(moved){score++;walkFrame=(walkFrame+1)%2;lastMove=now;}else{walkFrame=0;}}else{walkFrame=0;}
let it=gameData.items.find(i=>!i.taken&&i.x===playerX&&i.y===playerY);if(it){messagesDiv.textContent=`You see a ${it.name}. Press (T) to take.`;if(keys.t||keys.T){it.taken=true;playerStats.inventory.push(it.name);messagesDiv.textContent=`You took ${it.name}!`;}}
if(keys.i||keys.I){messagesDiv.textContent=`Inventory: [${playerStats.inventory.join(", ")}]`;}
let npc=gameData.npcs.find(n=>isAdjacent(playerX,playerY,n.x,n.y));if(npc){let st=npc.state;if(st>=npc.dialogues.length) st=npc.dialogues.length-1;dialoguesDiv.textContent=npc.dialogues[st];if(keys.e||keys.E){let line=npc.dialogues[npc.state];if(line.includes("(G)ood or (E)vil?")){if(keys.g||keys.G) npc.state+=2;else if(keys.e||keys.E) npc.state+=3;else npc.state++;}else if(line.includes("(Y/N)")){if(keys.y||keys.Y) npc.state+=2;else if(keys.n||keys.N) npc.state+=3;else npc.state++;}else{npc.state++;}if(npc.state>=npc.dialogues.length){npc.state=npc.dialogues.length-1;}}}
if(keys.s||keys.S){if(!rageActive){rageActive=true;rageTimer=now+5000;playerStats.SF+=20;messagesDiv.textContent="Szał Bitewny! (+20 SF for 5s)";}keys.s=false;keys.S=false;}
if(rageActive&&now>rageTimer){rageActive=false;playerStats.SF-=20;messagesDiv.textContent+="\nSzał Bitewny ends, SF back to normal.";}
for(let k in keys){if(k!=='ArrowUp'&&k!=='ArrowDown'&&k!=='ArrowLeft'&&k!=='ArrowRight'&&keys[k]) keys[k]=false;}
statsDiv.textContent=`ZYW:${playerStats.currentHP}/${playerStats.ZYW} | SF:${playerStats.SF} | ZR:${playerStats.ZR} | UM:${playerStats.UM} | WI:${playerStats.WI} | SZ:${playerStats.SZ} | PM:${playerStats.PM} | Time:${currentDayPhase()} | Score:${score}`;
let targetCamX=playerX-CAMERA_WIDTH/2;let targetCamY=playerY-CAMERA_HEIGHT/2;if(targetCamX<0) targetCamX=0;if(targetCamY<0) targetCamY=0;if(targetCamX+CAMERA_WIDTH>MAP_WIDTH) targetCamX=MAP_WIDTH-CAMERA_WIDTH;if(targetCamY+CAMERA_HEIGHT>MAP_HEIGHT) targetCamY=MAP_HEIGHT-CAMERA_HEIGHT;let speed=0.12;cameraXFloat+= (targetCamX-cameraXFloat)*speed;cameraYFloat+=(targetCamY-cameraYFloat)*speed;
render();requestAnimationFrame(gameLoop);}

function drawDiamond(sx,sy,color){ctx.fillStyle=color;ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(sx+TILE_W/2,sy+TILE_H/2);ctx.lineTo(sx,sy+TILE_H);ctx.lineTo(sx-TILE_W/2,sy+TILE_H/2);ctx.closePath();ctx.fill();}

function render(){ctx.clearRect(0,0,canvas.width,canvas.height);let relPlayerX=playerX-cameraXFloat;let relPlayerY=playerY-cameraYFloat;let centerX=canvas.width/2;let centerY=50;for(let row=0;row<=CAMERA_HEIGHT;row++){for(let col=0;col<=CAMERA_WIDTH;col++){let wx=Math.floor(cameraXFloat+col);let wy=Math.floor(cameraYFloat+row);if(wx<0||wy<0||wx>=MAP_WIDTH||wy>=MAP_HEIGHT) continue;let rx=wx-cameraXFloat;let ry=wy-cameraYFloat;let {sx,sy}=isoCoords(rx,ry);sx+=centerX;sy+=centerY;let tileName=map[wy][wx];let td=gameData.tileDefs[tileName]||gameData.tileDefs.GRASS;drawDiamond(sx,sy,td.color);let proj=gameData.projectiles.find(p=>p.x===wx&&p.y===wy);if(proj){ctx.fillStyle=gameData.specialTiles.FIREBALL.color;ctx.beginPath();ctx.arc(sx,sy+4,4,0,Math.PI*2);ctx.fill();}
let it=gameData.items.find(i=>!i.taken&&i.x===wx&&i.y===wy);if(it){ctx.fillStyle=gameData.specialTiles.ITEM.color;ctx.beginPath();ctx.moveTo(sx,sy+2);ctx.lineTo(sx+4,sy+TILE_H/2);ctx.lineTo(sx,sy+TILE_H-2);ctx.lineTo(sx-4,sy+TILE_H/2);ctx.closePath();ctx.fill();}
let npc=gameData.npcs.find(n=>n.x===wx&&n.y===wy);if(npc){ctx.fillStyle=npc.color||gameData.specialTiles.NPC.color;ctx.beginPath();ctx.arc(sx,sy+4,6,0,Math.PI*2);ctx.fill();}
if(wx===playerX&&wy===playerY){ctx.fillStyle=gameData.specialTiles.PLAYER;ctx.beginPath();ctx.arc(sx,sy+4,6,0,Math.PI*2);ctx.fill();}}}}

requestAnimationFrame(gameLoop);
</script>
</body>
</html>
