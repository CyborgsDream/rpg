<!-- RPG v 0.2.1 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>RPG v 0.2.1</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #000;
      color: #fff;
      font-family: Consolas, "Lucida Console", monospace;
      height: 100%; width: 100%;
      overflow: hidden;
    }
    #mainContainer {
      display: flex;
      flex-direction: row;
      width: 100%; height: 100vh;
      box-sizing: border-box;
    }
    #leftPanel {
      flex: 1 1 auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    #gameCanvas {
      background: #000;
      width: 100%;
      height: 100%;
    }
    #rightPanel {
      flex: 1 1 auto;
      padding: 1rem;
      background: #222;
      display: flex;
      flex-direction: column;
      overflow: auto;
    }
    #playerStats { margin-bottom: .5rem; font-size: 16px; color: #0f0; }
    #messages { margin-bottom: .5rem; font-size: 14px; color: #ff9; }
    #dialogues { margin-bottom: .5rem; font-size: 14px; color: #9cf; }
    #commandsHelp { font-size: 14px; color: #ccc; margin-top: auto; }
    #commandsHelp ul { list-style: none; margin: 0; padding: 0; }
    #commandsHelp li { margin-bottom: .3rem; }
    #commandsHelp strong { color: #fff; }
  </style>
</head>
<body>
<div id="mainContainer">
  <div id="leftPanel">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
  </div>
  <div id="rightPanel">
    <div id="playerStats"></div>
    <div id="messages"></div>
    <div id="dialogues"></div>
    <div id="commandsHelp">
      <strong>Commands (Ultima + KC):</strong>
      <ul>
        <li><strong>Arrow Keys</strong>: Move (~333 ms cooldown)</li>
        <li><strong>T</strong>: Take item on your tile</li>
        <li><strong>E</strong>: Talk to adjacent NPC (branching dialogues)</li>
        <li><strong>I</strong>: Show inventory</li>
        <li><strong>F</strong>: Block wizard’s fireball</li>
        <li><strong>S</strong>: "Szał Bitewny" (Rage) for +20 SF (5s)</li>
      </ul>
    </div>
  </div>
</div>

<script>
// ----- CONFIGURATION -----
const MAP_WIDTH = 128, MAP_HEIGHT = 48;
const CAMERA_WIDTH = 56, CAMERA_HEIGHT = 22;
const TILE_W = 48, TILE_H = 24, TILE_Z = 12;

const gameData = {
  tileDefs: {
    GRASS: { color: "#2f2", passable: true },
    FOREST: { color: "#0a0", passable: true },
    MOUNTAIN: { color: "#ddd", passable: false },
    HILL: { color: "#bbb", passable: true },
    WATER: { color: "#06a", passable: true },
    ROAD: { color: "#aaa", passable: true },
    WALL: { color: "#ccc", passable: false },
    CASTLE: { color: "#ccc", passable: false },
    CITY: { color: "#fa4", passable: true },
    VILLAGE: { color: "#e7c07d", passable: true },
    TOWER: { color: "#ccbbee", passable: false },
    FARM: { color: "#d8bf8e", passable: true }
  },
  specialTiles: {
    NPC: { color: "#0cf" },
    ITEM: { color: "#fa0" },
    FIREBALL: { color: "#f44" },
    PLAYER: "#ff7a00"
  },
  items: [
    { x: 10, y: 3, name: "Sword", taken: false },
    { x: 30, y: 8, name: "Potion", taken: false }
  ],
  npcs: [
    {
      name: "Guard",
      x: 15, y: 8,
      color: "#ff0",
      path: [{ x: 15, y: 8 }, { x: 19, y: 8 }, { x: 19, y: 10 }, { x: 15, y: 10 }],
      pathIndex: 0,
      state: 0,
      dialogues: [
        "Guard(0): \"Halt, traveler! (E) to talk.\"",
        "Guard(1): \"(1) Name? Keep pressing E...\"",
        "Guard(2): \"(2) We watch roads...\"",
        "Guard(3): \"(3) Are you (G)ood or (E)vil?\"",
        "Guard(4): \"(4) Aha, interesting...\"",
        "Guard(5): \"(5) 5 lines done, 5 left...\"",
        "Guard(6): \"(6) I'm bored...\"",
        "Guard(7): \"(7) 3 more...\"",
        "Guard(8): \"(8) 2 more...\"",
        "Guard(9): \"(9) 1 more...\"",
        "Guard(10): \"(10) Done. Bye!\""
      ]
    },
    {
      name: "Wizard",
      x: 40, y: 5,
      color: "#f0f",
      path: [{ x: 40, y: 5 }, { x: 44, y: 5 }, { x: 44, y: 9 }, { x: 40, y: 9 }],
      pathIndex: 0,
      state: 0,
      dialogues: [
        "Wizard(0): \"Greetings. (E) to chat.\"",
        "Wizard(1): \"(1) I'm studying fire magic... (Y/N)?\"",
        "Wizard(2): \"(2) Great, I'll show you some spells!\"",
        "Wizard(3): \"(3) Fine, I'll keep them secret.\"",
        "Wizard(4): \"(4) I might hurl a fireball, watch out!\"",
        "Wizard(5): \"(5) If you see it, press (F) to block...\"",
        "Wizard(6): \"(6) I'm done talking soon...\"",
        "Wizard(7): \"(7) 3 lines left...\"",
        "Wizard(8): \"(8) 2 lines...\"",
        "Wizard(9): \"(9) 1 line...\"",
        "Wizard(10): \"(10) Enough!\""
      ]
    }
  ],
  projectiles: []
};

let map = Array.from({length: MAP_HEIGHT}, () => Array(MAP_WIDTH).fill("GRASS"));

let heightMap = Array.from({length: MAP_HEIGHT+1}, () => Array(MAP_WIDTH+1).fill(0));
<!-- let heightMap = Array.from({length: MAP_HEIGHT}, () => Array(MAP_WIDTH).fill(0)); -->

function randElem(arr){return arr[Math.floor(Math.random()*arr.length)];}
const baseTerrains=["GRASS","FOREST","MOUNTAIN","HILL","WATER"];
for(let y=0;y<=MAP_HEIGHT;y++){
  for(let x=0;x<=MAP_WIDTH;x++){
    let h=Math.floor(Math.random()*4);
    if(x>0&&y>0){
      h=Math.round((h+heightMap[y-1][x]+heightMap[y][x-1]+heightMap[y-1][x-1])/4);
    }else if(x>0){
      h=Math.round((h+heightMap[y][x-1])/2);
    }else if(y>0){
      h=Math.round((h+heightMap[y-1][x])/2);
    }
    heightMap[y][x]=h;
  }
}
for(let y=0;y<MAP_HEIGHT;y++){
  for(let x=0;x<MAP_WIDTH;x++){
    map[y][x]=randElem(baseTerrains);
    let h=Math.floor(Math.random()*4);
    if(x>0&&y>0) h=Math.round((h+heightMap[y-1][x]+heightMap[y][x-1])/3);
    heightMap[y][x]=h;
  }
}

function carveRoad(x1,y1,x2,y2){
  let cx=x1, cy=y1;
  map[cy][cx]="ROAD";
  while(cx!==x2||cy!==y2){
    if(Math.abs(x2-cx)>Math.abs(y2-cy)) cx+= (x2>cx?1:-1); else cy+= (y2>cy?1:-1);
    if(cx>=0&&cy>=0&&cx<MAP_WIDTH&&cy<MAP_HEIGHT) map[cy][cx]="ROAD";
  }
}

function placeRect(x,y,w,h,type){
  for(let yy=y;yy<y+h;yy++){
    if(yy<0||yy>=MAP_HEIGHT) continue;
    for(let xx=x;xx<x+w;xx++){
      if(xx<0||xx>=MAP_WIDTH) continue;
      map[yy][xx]=type;
    }
  }
}

// City with walls
for(let yy=10;yy<16;yy++){for(let xx=70;xx<76;xx++){map[yy][xx]="CITY";}}
for(let xx=69;xx<=76;xx++){map[10][xx]="WALL";map[15][xx]="WALL";}
for(let yy=10;yy<=15;yy++){map[yy][69]="WALL";map[yy][76]="WALL";}

// Castle keep
placeRect(32,18,4,4,"CASTLE");

// Rural features
placeRect(18,28,6,4,"VILLAGE");
placeRect(22,24,4,3,"FARM");
placeRect(50,6,3,3,"TOWER");
placeRect(90,26,5,4,"VILLAGE");
placeRect(94,22,4,3,"FARM");
placeRect(112,34,6,4,"CITY");

// Road network linking notable spots
const roadNodes=[
  {x:10,y:10}, // spawn
  {x:32,y:20}, // castle
  {x:22,y:26}, // village cluster
  {x:52,y:8},  // tower
  {x:72,y:12}, // walled city
  {x:92,y:24}, // village east
  {x:114,y:36} // eastern city
];
for(let i=0;i<roadNodes.length-1;i++){
  carveRoad(roadNodes[i].x,roadNodes[i].y,roadNodes[i+1].x,roadNodes[i+1].y);
}

let isRunning=true;
let score=0;
let playerX=10,playerY=10;
let walkFrame=0,moveDelay=333,lastMove=0;
let playerStats={name:"BezImienny",ZYW:100,currentHP:100,SF:60,ZR:50,UM:30,WI:40,SZ:20,PM:20,inventory:[]};
let rageActive=false,rageTimer=0;
let dayTime=0;function currentDayPhase(){if(dayTime<1200) return"Day";else if(dayTime<1800) return"Evening";else return"Night";}

let keys={ArrowUp:false,ArrowDown:false,ArrowLeft:false,ArrowRight:false,t:false,T:false,e:false,E:false,i:false,I:false,f:false,F:false,s:false,S:false,g:false,G:false,y:false,Y:false,n:false,N:false};
window.addEventListener("keydown",e=>{if(keys[e.key]!==undefined) keys[e.key]=true;});
window.addEventListener("keyup",e=>{if(keys[e.key]!==undefined) keys[e.key]=false;});

const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const messagesDiv=document.getElementById('messages');
const dialoguesDiv=document.getElementById('dialogues');
const statsDiv=document.getElementById('playerStats');

function resizeCanvas(){
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function isNPCat(nx,ny){return gameData.npcs.find(n=>n.x===nx&&n.y===ny);} 
function isPassable(nx,ny){if(nx<0||ny<0||nx>=MAP_WIDTH||ny>=MAP_HEIGHT) return false;let npc=isNPCat(nx,ny);if(npc) return false;let td=gameData.tileDefs[map[ny][nx]]||gameData.tileDefs.GRASS;return td.passable!==false;} 
function isAdjacent(px,py,nx,ny){return Math.abs(px-nx)+Math.abs(py-ny)===1;}

let npcMoveInterval=1000,lastNPCmove=0;
function updateNPCs(){let now=Date.now();if(now-lastNPCmove<npcMoveInterval) return;lastNPCmove=now;for(let npc of gameData.npcs){if(!npc.path||npc.path.length<2) continue;if(npc.pathIndex===undefined) npc.pathIndex=0;let tgt=npc.path[npc.pathIndex];if(npc.x===tgt.x&&npc.y===tgt.y){npc.pathIndex=(npc.pathIndex+1)%npc.path.length;tgt=npc.path[npc.pathIndex];}let dx=0,dy=0;if(npc.x<tgt.x) dx=1;else if(npc.x>tgt.x) dx=-1;else if(npc.y<tgt.y) dy=1;else if(npc.y>tgt.y) dy=-1;let nx=npc.x+dx,ny=npc.y+dy;if(isPassable(nx,ny)){npc.x=nx;npc.y=ny;}}
let wizard=gameData.npcs.find(n=>n.name==="Wizard");if(wizard&&Math.random()<0.33){let dx=playerX-wizard.x,dy=playerY-wizard.y;if(Math.abs(dx)>Math.abs(dy)){gameData.projectiles.push({x:wizard.x,y:wizard.y,dx:(dx>0?1:-1),dy:0,type:"FIREBALL"});messagesDiv.textContent="Wizard hurls a fireball horizontally!";}else{gameData.projectiles.push({x:wizard.x,y:wizard.y,dx:0,dy:(dy>0?1:-1),type:"FIREBALL"});messagesDiv.textContent="Wizard flings a vertical fireball!";}}}

function updateProjectiles(){let removeList=[];for(let p of gameData.projectiles){p.x+=p.dx;p.y+=p.dy;if(p.x<0||p.y<0||p.x>=MAP_WIDTH||p.y>=MAP_HEIGHT){removeList.push(p);continue;}if(p.x===playerX&&p.y===playerY){if(keys.f||keys.F){messagesDiv.textContent="You block the fireball with perfect timing!";}else{playerStats.currentHP-=10;messagesDiv.textContent="Fireball hits you for 10 damage!";if(playerStats.currentHP<=0){playerStats.currentHP=0;messagesDiv.textContent+=" You died! Game Over.";isRunning=false;}}removeList.push(p);}else if(!isPassable(p.x,p.y)){removeList.push(p);}}
gameData.projectiles=gameData.projectiles.filter(x=>!removeList.includes(x));}

let lastDayUpdate=0;messagesDiv.textContent="Map generated. Use arrow keys to move. 'S' for Szał. 'F' to block fireballs.";

let cameraXFloat=0,cameraYFloat=0;
function isoPoint(rx,ry,h=0){
  return {sx:(rx-ry)*TILE_W/2, sy:(rx+ry)*TILE_H/2 - h*TILE_Z};
}

function shadeColor(col,amt){
  if(col.length===4) col="#"+col[1]+col[1]+col[2]+col[2]+col[3]+col[3];
  let num=parseInt(col.slice(1),16);
  let r=(num>>16)+amt,g=((num>>8)&0xFF)+amt,b=(num&0xFF)+amt;
  r=Math.min(255,Math.max(0,r));
  g=Math.min(255,Math.max(0,g));
  b=Math.min(255,Math.max(0,b));
  return"#"+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
}

function gameLoop(){if(!isRunning) return;let now=Date.now();if(now-lastDayUpdate>1000){dayTime=(dayTime+20)%2400;lastDayUpdate=now;}updateNPCs();updateProjectiles();if(now-lastMove>=moveDelay){let moved=false;if(keys.ArrowUp&&isPassable(playerX,playerY-1)){playerY--;moved=true;}else if(keys.ArrowDown&&isPassable(playerX,playerY+1)){playerY++;moved=true;}else if(keys.ArrowLeft&&isPassable(playerX-1,playerY)){playerX--;moved=true;}else if(keys.ArrowRight&&isPassable(playerX+1,playerY)){playerX++;moved=true;}if(moved){score++;walkFrame=(walkFrame+1)%2;lastMove=now;}else{walkFrame=0;}}else{walkFrame=0;}
let it=gameData.items.find(i=>!i.taken&&i.x===playerX&&i.y===playerY);if(it){messagesDiv.textContent=`You see a ${it.name}. Press (T) to take.`;if(keys.t||keys.T){it.taken=true;playerStats.inventory.push(it.name);messagesDiv.textContent=`You took ${it.name}!`;}}
if(keys.i||keys.I){messagesDiv.textContent=`Inventory: [${playerStats.inventory.join(", ")}]`;}
let npc=gameData.npcs.find(n=>isAdjacent(playerX,playerY,n.x,n.y));if(npc){let st=npc.state;if(st>=npc.dialogues.length) st=npc.dialogues.length-1;dialoguesDiv.textContent=npc.dialogues[st];if(keys.e||keys.E){let line=npc.dialogues[npc.state];if(line.includes("(G)ood or (E)vil?")){if(keys.g||keys.G) npc.state+=2;else if(keys.e||keys.E) npc.state+=3;else npc.state++;}else if(line.includes("(Y/N)")){if(keys.y||keys.Y) npc.state+=2;else if(keys.n||keys.N) npc.state+=3;else npc.state++;}else{npc.state++;}if(npc.state>=npc.dialogues.length){npc.state=npc.dialogues.length-1;}}}
if(keys.s||keys.S){if(!rageActive){rageActive=true;rageTimer=now+5000;playerStats.SF+=20;messagesDiv.textContent="Szał Bitewny! (+20 SF for 5s)";}keys.s=false;keys.S=false;}
if(rageActive&&now>rageTimer){rageActive=false;playerStats.SF-=20;messagesDiv.textContent+="\nSzał Bitewny ends, SF back to normal.";}
for(let k in keys){if(k!=='ArrowUp'&&k!=='ArrowDown'&&k!=='ArrowLeft'&&k!=='ArrowRight'&&keys[k]) keys[k]=false;}
statsDiv.textContent=`ZYW:${playerStats.currentHP}/${playerStats.ZYW} | SF:${playerStats.SF} | ZR:${playerStats.ZR} | UM:${playerStats.UM} | WI:${playerStats.WI} | SZ:${playerStats.SZ} | PM:${playerStats.PM} | Time:${currentDayPhase()} | Score:${score}`;
let targetCamX=playerX-CAMERA_WIDTH/2;let targetCamY=playerY-CAMERA_HEIGHT/2;if(targetCamX<0) targetCamX=0;if(targetCamY<0) targetCamY=0;if(targetCamX+CAMERA_WIDTH>MAP_WIDTH) targetCamX=MAP_WIDTH-CAMERA_WIDTH;if(targetCamY+CAMERA_HEIGHT>MAP_HEIGHT) targetCamY=MAP_HEIGHT-CAMERA_HEIGHT;let speed=0.12;cameraXFloat+= (targetCamX-cameraXFloat)*speed;cameraYFloat+=(targetCamY-cameraYFloat)*speed;
render();requestAnimationFrame(gameLoop);}

function drawTile(p1,p2,p3,p4,color){
  ctx.fillStyle=color;
  ctx.beginPath();
  ctx.moveTo(p1.sx,p1.sy);
  ctx.lineTo(p2.sx,p2.sy);
  ctx.lineTo(p3.sx,p3.sy);
  ctx.lineTo(p4.sx,p4.sy);
  ctx.closePath();
  ctx.fill();
}

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const centerX=canvas.width/2;
  const centerY=90;
  for(let row=0;row<=CAMERA_HEIGHT;row++){
    for(let col=0;col<=CAMERA_WIDTH;col++){
      const wx=Math.floor(cameraXFloat+col);
      const wy=Math.floor(cameraYFloat+row);
      if(wx<0||wy<0||wx>=MAP_WIDTH||wy>=MAP_HEIGHT) continue;
      const rx=wx-cameraXFloat;
      const ry=wy-cameraYFloat;
      const hNW=heightMap[wy][wx];
      const hNE=heightMap[wy][wx+1];
      const hSW=heightMap[wy+1][wx];
      const hSE=heightMap[wy+1][wx+1];
      const baseHeight=Math.min(hNW,hNE,hSW,hSE,0);

      const pNW=isoPoint(rx,ry,hNW);
      const pNE=isoPoint(rx+1,ry,hNE);
      const pSE=isoPoint(rx+1,ry+1,hSE);
      const pSW=isoPoint(rx,ry+1,hSW);
      const bNW=isoPoint(rx,ry,baseHeight);
      const bNE=isoPoint(rx+1,ry,baseHeight);
      const bSE=isoPoint(rx+1,ry+1,baseHeight);
      const bSW=isoPoint(rx,ry+1,baseHeight);

      for (const pt of [pNW,pNE,pSE,pSW,bNW,bNE,bSE,bSW]) {
        pt.sx+=centerX;
        pt.sy+=centerY;
      }

      const tileName=map[wy][wx];
      const td=gameData.tileDefs[tileName]||gameData.tileDefs.GRASS;
      const avgH=(hNW+hNE+hSW+hSE)/4;
      const topColor=shadeColor(td.color,-avgH*10);
      const leftColor=shadeColor(topColor,-25);
      const rightColor=shadeColor(topColor,-15);
      const frontColor=shadeColor(topColor,-35);

      if(Math.max(hNW,hSW)>baseHeight){
        drawTile(pNW,pSW,bSW,bNW,leftColor);
      }
      if(Math.max(hNE,hSE)>baseHeight){
        drawTile(pNE,pSE,bSE,bNE,rightColor);
      }
      if(Math.max(hSW,hSE)>baseHeight){
        drawTile(pSW,pSE,bSE,bSW,frontColor);
      }

      drawTile(pNW,pNE,pSE,pSW,topColor);

      const center=isoPoint(rx+0.5,ry+0.5,avgH);
      center.sx+=centerX;center.sy+=centerY;
      const proj=gameData.projectiles.find(p=>p.x===wx&&p.y===wy);
      if(proj){ctx.fillStyle=gameData.specialTiles.FIREBALL.color;ctx.beginPath();ctx.arc(center.sx,center.sy+4,4,0,Math.PI*2);ctx.fill();}
      const it=gameData.items.find(i=>!i.taken&&i.x===wx&&i.y===wy);
      if(it){ctx.fillStyle=gameData.specialTiles.ITEM.color;ctx.beginPath();ctx.moveTo(center.sx,center.sy+2);ctx.lineTo(center.sx+4,center.sy+TILE_H/2);ctx.lineTo(center.sx,center.sy+TILE_H-2);ctx.lineTo(center.sx-4,center.sy+TILE_H/2);ctx.closePath();ctx.fill();}
      const npc=gameData.npcs.find(n=>n.x===wx&&n.y===wy);
      if(npc){ctx.fillStyle=npc.color||gameData.specialTiles.NPC.color;ctx.beginPath();ctx.arc(center.sx,center.sy+4,6,0,Math.PI*2);ctx.fill();}
      if(wx===playerX&&wy===playerY){ctx.fillStyle=gameData.specialTiles.PLAYER;ctx.beginPath();ctx.arc(center.sx,center.sy+4,6,0,Math.PI*2);ctx.fill();}
      if(wx===playerX&&wy===playerY){
        ctx.strokeStyle="#ffeb3b";
        ctx.lineWidth=2;
        ctx.beginPath();
        ctx.moveTo(pNW.sx,pNW.sy);
        ctx.lineTo(pNE.sx,pNE.sy);
        ctx.lineTo(pSE.sx,pSE.sy);
        ctx.lineTo(pSW.sx,pSW.sy);
        ctx.closePath();
        ctx.stroke();
        ctx.lineWidth=1;
      }
    }
  }
}
requestAnimationFrame(gameLoop);
</script>
</body>
<!-- RPG v 0.2.1 -->
</html>
